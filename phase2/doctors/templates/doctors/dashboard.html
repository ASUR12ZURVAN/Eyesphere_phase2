{% extends "optometrist/base.html" %}

{% block title %}Doctor Dashboard | EyeSphere{% endblock title %}

{% block extra_head %}
<style>
    .dashboard-container {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
    }

    .glass-card {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.4);
        border-radius: 24px;
        padding: 2rem;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
    }

    .stats-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid transparent;
    }

    .stats-card:hover {
        transform: translateY(-5px);
        border-color: var(--secondary);
    }

    .patient-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 0.75rem;
    }

    .patient-table tr {
        transition: all 0.2s ease;
    }

    .patient-table tbody tr {
        background: rgba(255, 255, 255, 0.5);
        cursor: pointer;
    }

    .patient-table tbody tr:hover {
        background: white;
        transform: scale(1.005);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
    }

    .patient-table td,
    .patient-table th {
        padding: 1.25rem;
        text-align: left;
    }

    .patient-table th {
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
    }

    .patient-table tr td:first-child {
        border-radius: 12px 0 0 12px;
    }

    .patient-table tr td:last-child {
        border-radius: 0 12px 12px 0;
    }

    .badge {
        padding: 0.4rem 0.8rem;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .badge-pink {
        background: rgba(219, 39, 119, 0.1);
        color: var(--secondary);
    }

    .badge-blue {
        background: rgba(37, 99, 235, 0.1);
        color: var(--primary);
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(15, 23, 42, 0.4);
        backdrop-filter: blur(4px);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        padding: 2rem;
    }

    .modal-content {
        background: white;
        width: 100%;
        max-width: 650px;
        border-radius: 24px;
        position: relative;
        padding: 2.5rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
        max-height: 90vh;
        overflow-y: auto;
    }

    .detail-row {
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #f1f5f9;
    }

    .detail-label {
        font-size: 0.8rem;
        color: var(--text-muted);
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 0.4rem;
    }

    .detail-value {
        font-size: 1.1rem;
        color: var(--text-main);
        line-height: 1.5;
    }

    .close-modal {
        position: absolute;
        top: 1.5rem;
        right: 1.5rem;
        cursor: pointer;
        color: var(--text-muted);
        transition: color 0.2s;
    }

    .close-modal:hover {
        color: var(--secondary);
    }
</style>
{% endblock extra_head %}

{% block content %}
<div class="dashboard-container animate-fade-in">
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 3rem;">
        <div>
            <h1 style="text-align: left; font-size: 2.5rem; margin-bottom: 0.5rem; margin-top: 0;">Specialist Dashboard
            </h1>
            <p style="color: var(--text-muted); font-size: 1.1rem;">
                Welcome, <span id="doctorNameDisplay" style="color: var(--secondary); font-weight: 600;">Dr.
                    Loading...</span>
            </p>
        </div>
        <button onclick="logout()" class="btn"
            style="width: auto; height: 48px; padding: 0 1.5rem; background: white; border: 1px solid #e2e8f0; color: #ef4444; font-weight: 600;">
            Logout
        </button>
    </div>

    <!-- Quick Stats -->
    <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 3rem;">
        <div class="glass-card stats-card" style="display: flex; align-items: center; gap: 1.5rem;">
            <div
                style="width: 56px; height: 56px; background: rgba(219, 39, 119, 0.1); border-radius: 16px; display: flex; align-items: center; justify-content: center; color: var(--secondary);">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                    <circle cx="9" cy="7" r="4" />
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                    <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                </svg>
            </div>
            <div>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.2rem;">Total Patients</p>
                <h3 style="font-size: 1.75rem; font-weight: 700;">{{ examinations.count }}</h3>
            </div>
        </div>

        <div class="glass-card stats-card" style="display: flex; align-items: center; gap: 1.5rem;">
            <div
                style="width: 56px; height: 56px; background: rgba(37, 99, 235, 0.1); border-radius: 16px; display: flex; align-items: center; justify-content: center; color: var(--primary);">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                    <line x1="16" y1="2" x2="16" y2="6" />
                    <line x1="8" y1="2" x2="8" y2="6" />
                    <line x1="3" y1="10" x2="21" y2="10" />
                </svg>
            </div>
            <div>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.2rem;">New Requests</p>
                <h3 style="font-size: 1.75rem; font-weight: 700;">Active</h3>
            </div>
        </div>

        <div class="glass-card stats-card" style="display: flex; align-items: center; gap: 1.5rem;">
            <div
                style="width: 56px; height: 56px; background: rgba(5, 150, 105, 0.1); border-radius: 16px; display: flex; align-items: center; justify-content: center; color: #059669;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
                </svg>
            </div>
            <div>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.2rem;">Status</p>
                <h3 style="font-size: 1.75rem; font-weight: 700;">Online</h3>
            </div>
        </div>
    </div>

    <!-- Live Patient List -->
    <div class="glass-card" style="padding: 2.5rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h2 style="font-size: 1.5rem; text-align: left;">Assigned Patient Referrals</h2>
            <div style="color: var(--text-muted); font-size: 0.9rem;">
                Sorted by latest referral
            </div>
        </div>

        <div style="overflow-x: auto;">
            <table class="patient-table">
                <thead>
                    <tr>
                        <th>Patient Name</th>
                        <th>Age/Gender</th>
                        <th>Referring Optometrist</th>
                        <th>Date Received</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for exam in examinations %}
                    <tr onclick="showPatientDetails({
                        name: '{{ exam.patient.name|escapejs }}',
                        age: '{{ exam.patient.age }}',
                        gender: '{{ exam.patient.gender|title }}',
                        optometrist: '{{ exam.optometrist.name|escapejs }}',
                        complaint: '{{ exam.chief_complaints|escapejs }}',
                        findings: '{{ exam.provisional_diagnosis|escapejs }}',
                        notes: '{{ exam.advice|default:" No extra notes"|escapejs }}',
                        date: '{{ exam.created_at|date:"d M Y, H:i" }}' , va: { uncorrected: {
                        re: '{{ exam.uncorrected_vision_re|escapejs }}' ,
                        le: '{{ exam.uncorrected_vision_le|escapejs }}' }, pinhole: {
                        re: '{{ exam.pinhole_vision_re|escapejs }}' , le: '{{ exam.pinhole_vision_le|escapejs }}' },
                        corrected: { re: '{{ exam.corrected_vision_re|escapejs }}' ,
                        le: '{{ exam.corrected_vision_le|escapejs }}' } }, refraction: { dv: { re: {
                        sph: '{{ exam.dv_sph_re|escapejs }}' , cyl: '{{ exam.dv_cyl_re|escapejs }}' ,
                        axis: '{{ exam.dv_axis_re|escapejs }}' , vision: '{{ exam.dv_vision_re|escapejs }}' }, le: {
                        sph: '{{ exam.dv_sph_le|escapejs }}' , cyl: '{{ exam.dv_cyl_le|escapejs }}' ,
                        axis: '{{ exam.dv_axis_le|escapejs }}' , vision: '{{ exam.dv_vision_le|escapejs }}' } }, nv: {
                        re: { sph: '{{ exam.nv_sph_re|escapejs }}' , cyl: '{{ exam.nv_cyl_re|escapejs }}' ,
                        axis: '{{ exam.nv_axis_re|escapejs }}' , vision: '{{ exam.nv_vision_re|escapejs }}' }, le: {
                        sph: '{{ exam.nv_sph_le|escapejs }}' , cyl: '{{ exam.nv_cyl_le|escapejs }}' ,
                        axis: '{{ exam.nv_axis_le|escapejs }}' , vision: '{{ exam.nv_vision_le|escapejs }}' } } },
                        investigations: { slitlamp: { re: '{{ exam.slit_lamp_re|escapejs }}' ,
                        le: '{{ exam.slit_lamp_le|escapejs }}' }, fundus: { re: '{{ exam.fundus_re|escapejs }}' ,
                        le: '{{ exam.fundus_le|escapejs }}' }, iop: { re: '{{ exam.iop_re|escapejs }}' ,
                        le: '{{ exam.iop_le|escapejs }}' } } })">
                        <td style="font-weight: 600;">{{ exam.patient.name }}</td>
                        <td>{{ exam.patient.age }}y / {{ exam.patient.gender|title }}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div
                                    style="width: 24px; height: 24px; background: #f1f5f9; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 700; color: var(--primary);">
                                    {{ exam.optometrist.name|slice:":1"|upper }}
                                </div>
                                {{ exam.optometrist.name }}
                            </div>
                        </td>
                        <td style="color: var(--text-muted);">{{ exam.created_at|date:"d M Y" }}</td>
                        <td><span class="badge badge-pink">Pending Review</span></td>
                        <td>
                            <button class="btn"
                                style="width: auto; padding: 0.5rem 1rem; font-size: 0.85rem; background: var(--primary); color: white;">
                                View Details
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 4rem; color: var(--text-muted);">
                            <p>No patients have been referred to you yet.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div id="patientDetailModal" class="modal">
    <div class="modal-content animate-fade-in" style="animation-duration: 0.4s;">
        <span class="close-modal" onclick="closeModal()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <line x1="18" y1="6" x2="6" y2="18" />
                <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
        </span>
        <h2 id="modalPatientName" style="text-align: left; margin-bottom: 0.5rem; font-size: 1.8rem;">Patient Details
        </h2>
        <div id="modalDate" style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 2rem;">Referral Date
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div class="detail-row">
                <div class="detail-label">Age / Gender</div>
                <div id="modalAgeGender" class="detail-value">-</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Referring Optometrist</div>
                <div id="modalOptometrist" class="detail-value">-</div>
            </div>
        </div>
        <div class="detail-row">
            <div class="detail-label">Chief Complaint</div>
            <div id="modalComplaint" class="detail-value">-</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">Optometrist Findings</div>
            <div id="modalFindings" class="detail-value"
                style="padding: 1rem; background: #f8fafc; border-radius: 12px; border-left: 4px solid var(--primary);">
                -</div>
        </div>

        <!-- Expanded Clinical Data -->
        <h3
            style="margin-top:1.5rem; margin-bottom:0.5rem; font-size:1.1rem; color:var(--secondary); border-bottom:1px solid #eee; padding-bottom:0.5rem;">
            Visual Acuity</h3>
        <table style="width:100%; font-size:0.9rem; margin-bottom:1.5rem; border-collapse: collapse;">
            <tr style="background:#f8fafc; color:var(--text-muted); font-weight:600;">
                <td style="padding:0.5rem;"></td>
                <td style="padding:0.5rem;">Right Eye</td>
                <td style="padding:0.5rem;">Left Eye</td>
            </tr>
            <tr>
                <td style="padding:0.5rem; border-bottom:1px solid #eee;">Uncorrected</td>
                <td id="modVaUnRe" style="padding:0.5rem; border-bottom:1px solid #eee;">-</td>
                <td id="modVaUnLe" style="padding:0.5rem; border-bottom:1px solid #eee;">-</td>
            </tr>
            <tr>
                <td style="padding:0.5rem; border-bottom:1px solid #eee;">Pinhole</td>
                <td id="modVaPhRe" style="padding:0.5rem; border-bottom:1px solid #eee;">-</td>
                <td id="modVaPhLe" style="padding:0.5rem; border-bottom:1px solid #eee;">-</td>
            </tr>
            <tr>
                <td style="padding:0.5rem; border-bottom:1px solid #eee;">Corrected</td>
                <td id="modVaCorRe" style="padding:0.5rem; border-bottom:1px solid #eee;">-</td>
                <td id="modVaCorLe" style="padding:0.5rem; border-bottom:1px solid #eee;">-</td>
            </tr>
        </table>

        <!-- Refraction -->
        <h3
            style="margin-top:1.5rem; margin-bottom:0.5rem; font-size:1.1rem; color:var(--secondary); border-bottom:1px solid #eee; padding-bottom:0.5rem;">
            Refraction</h3>
        <table
            style="width:100%; font-size:0.85rem; margin-bottom:1.5rem; border-collapse: collapse; text-align:center;">
            <tr style="background:#f8fafc; color:var(--text-muted); font-weight:600;">
                <td style="padding:0.5rem;"></td>
                <td colspan="4" style="padding:0.5rem; border-right:1px solid #eee;">Right Eye</td>
                <td colspan="4" style="padding:0.5rem;">Left Eye</td>
            </tr>
            <tr style="background:#f8fafc; color:var(--text-muted); font-size:0.75rem;">
                <td style="padding:0.2rem;"></td>
                <td>Sph</td>
                <td>Cyl</td>
                <td>Ax</td>
                <td style="border-right:1px solid #eee;">Vis</td>
                <td>Sph</td>
                <td>Cyl</td>
                <td>Ax</td>
                <td>Vis</td>
            </tr>
            <tr>
                <td style="padding:0.5rem; text-align:left; font-weight:600; border-bottom:1px solid #eee;">DV</td>
                <td id="modRefDvReSph" style="border-bottom:1px solid #eee;">-</td>
                <td id="modRefDvReCyl" style="border-bottom:1px solid #eee;">-</td>
                <td id="modRefDvReAx" style="border-bottom:1px solid #eee;">-</td>
                <td id="modRefDvReVis" style="border-bottom:1px solid #eee; border-right:1px solid #eee;">-</td>

                <td id="modRefDvLeSph" style="border-bottom:1px solid #eee;">-</td>
                <td id="modRefDvLeCyl" style="border-bottom:1px solid #eee;">-</td>
                <td id="modRefDvLeAx" style="border-bottom:1px solid #eee;">-</td>
                <td id="modRefDvLeVis" style="border-bottom:1px solid #eee;">-</td>
            </tr>
            <tr>
                <td style="padding:0.5rem; text-align:left; font-weight:600; border-bottom:1px solid #eee;">NV</td>
                <td id="modRefNvReSph" style="border-bottom:1px solid #eee;">-</td>
                <td id="modRefNvReCyl" style="border-bottom:1px solid #eee;">-</td>
                <td id="modRefNvReAx" style="border-bottom:1px solid #eee;">-</td>
                <td id="modRefNvReVis" style="border-bottom:1px solid #eee; border-right:1px solid #eee;">-</td>

                <td id="modRefNvLeSph" style="border-bottom:1px solid #eee;">-</td>
                <td id="modRefNvLeCyl" style="border-bottom:1px solid #eee;">-</td>
                <td id="modRefNvLeAx" style="border-bottom:1px solid #eee;">-</td>
                <td id="modRefNvLeVis" style="border-bottom:1px solid #eee;">-</td>
            </tr>
        </table>

        <h3
            style="margin-top:1.5rem; margin-bottom:0.5rem; font-size:1.1rem; color:var(--secondary); border-bottom:1px solid #eee; padding-bottom:0.5rem;">
            Investigations</h3>
        <table style="width:100%; font-size:0.9rem; margin-bottom:1.5rem; border-collapse: collapse;">
            <tr style="background:#f8fafc; color:var(--text-muted); font-weight:600;">
                <td style="padding:0.5rem;">test</td>
                <td style="padding:0.5rem;">Right Eye</td>
                <td style="padding:0.5rem;">Left Eye</td>
            </tr>
            <tr>
                <td style="padding:0.5rem; border-bottom:1px solid #eee;">Slit Lamp</td>
                <td id="modSlitRe" style="padding:0.5rem; border-bottom:1px solid #eee;">-</td>
                <td id="modSlitLe" style="padding:0.5rem; border-bottom:1px solid #eee;">-</td>
            </tr>
            <tr>
                <td style="padding:0.5rem; border-bottom:1px solid #eee;">Fundus</td>
                <td id="modFundusRe" style="padding:0.5rem; border-bottom:1px solid #eee;">-</td>
                <td id="modFundusLe" style="padding:0.5rem; border-bottom:1px solid #eee;">-</td>
            </tr>
            <tr>
                <td style="padding:0.5rem; border-bottom:1px solid #eee;">IOP</td>
                <td id="modIopRe" style="padding:0.5rem; border-bottom:1px solid #eee;">-</td>
                <td id="modIopLe" style="padding:0.5rem; border-bottom:1px solid #eee;">-</td>
            </tr>
        </table>
        <div class="detail-row" style="border-bottom: none;">
            <div class="detail-label">Additional Notes</div>
            <div id="modalNotes" class="detail-value">-</div>
        </div>
        <div style="margin-top: 2rem; display: flex; gap: 1rem;">
            <button class="btn btn-primary" style="flex: 1;">Accept Case</button>
            <button class="btn" style="flex: 1; background: #f1f5f9; color: var(--text-main);"
                onclick="closeModal()">Close Details</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user || user.role !== 'doctor') {
            window.location.href = '{% url "doctor_login_page" %}';
            return;
        }
        document.getElementById('doctorNameDisplay').innerText = `Dr. ${user.name}`;
    });

    function showPatientDetails(data) {
        document.getElementById('modalPatientName').innerText = data.name;
        document.getElementById('modalAgeGender').innerText = `${data.age} years / ${data.gender}`;
        document.getElementById('modalOptometrist').innerText = `Dr. ${data.optometrist}`;
        document.getElementById('modalComplaint').innerText = data.complaint;
        document.getElementById('modalFindings').innerText = data.findings;
        document.getElementById('modalNotes').innerText = data.notes;
        document.getElementById('modalDate').innerText = `Referral received on: ${data.date}`;

        // Populate Clinical Data
        if (data.va) {
            document.getElementById('modVaUnRe').innerText = data.va.uncorrected.re || '-';
            document.getElementById('modVaUnLe').innerText = data.va.uncorrected.le || '-';
            document.getElementById('modVaPhRe').innerText = data.va.pinhole.re || '-';
            document.getElementById('modVaPhLe').innerText = data.va.pinhole.le || '-';
            document.getElementById('modVaCorRe').innerText = data.va.corrected.re || '-';
            document.getElementById('modVaCorLe').innerText = data.va.corrected.le || '-';
        }

        if (data.refraction) {
            // DV
            document.getElementById('modRefDvReSph').innerText = data.refraction.dv.re.sph || '';
            document.getElementById('modRefDvReCyl').innerText = data.refraction.dv.re.cyl || '';
            document.getElementById('modRefDvReAx').innerText = data.refraction.dv.re.axis || '';
            document.getElementById('modRefDvReVis').innerText = data.refraction.dv.re.vision || '';

            document.getElementById('modRefDvLeSph').innerText = data.refraction.dv.le.sph || '';
            document.getElementById('modRefDvLeCyl').innerText = data.refraction.dv.le.cyl || '';
            document.getElementById('modRefDvLeAx').innerText = data.refraction.dv.le.axis || '';
            document.getElementById('modRefDvLeVis').innerText = data.refraction.dv.le.vision || '';

            // NV
            document.getElementById('modRefNvReSph').innerText = data.refraction.nv.re.sph || '';
            document.getElementById('modRefNvReCyl').innerText = data.refraction.nv.re.cyl || '';
            document.getElementById('modRefNvReAx').innerText = data.refraction.nv.re.axis || '';
            document.getElementById('modRefNvReVis').innerText = data.refraction.nv.re.vision || '';

            document.getElementById('modRefNvLeSph').innerText = data.refraction.nv.le.sph || '';
            document.getElementById('modRefNvLeCyl').innerText = data.refraction.nv.le.cyl || '';
            document.getElementById('modRefNvLeAx').innerText = data.refraction.nv.le.axis || '';
            document.getElementById('modRefNvLeVis').innerText = data.refraction.nv.le.vision || '';
        }

        if (data.investigations) {
            document.getElementById('modSlitRe').innerText = data.investigations.slitlamp.re || '-';
            document.getElementById('modSlitLe').innerText = data.investigations.slitlamp.le || '-';
            document.getElementById('modFundusRe').innerText = data.investigations.fundus.re || '-';
            document.getElementById('modFundusLe').innerText = data.investigations.fundus.le || '-';
            document.getElementById('modIopRe').innerText = data.investigations.iop.re || '-';
            document.getElementById('modIopLe').innerText = data.investigations.iop.le || '-';
        }

        document.getElementById('patientDetailModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('patientDetailModal').style.display = 'none';
    }

    window.onclick = function (event) {
        if (event.target == document.getElementById('patientDetailModal')) closeModal();
    }

    function logout() {
        localStorage.clear();
        window.location.href = '{% url "landing_page" %}';
    }
</script>
{% endblock content %}